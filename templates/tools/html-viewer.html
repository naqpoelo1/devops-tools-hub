<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HTML Viewer & Editor</title>
  
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/favicon.png') }}">

  <script src="{{ url_for('static', filename='js/tailwind-latest.js') }}" crossorigin="anonymous"></script>
  <link href="{{ url_for('static', filename='css/bootstrap-icons.min.css') }}" rel="stylesheet" />
  
  <!-- CodeMirror -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/xq-light.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.css">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
  <script src="{{ url_for('static', filename='js/theme.js') }}"></script>

  <style>
    body {
        background-color: var(--bg);
        color: var(--text);
        transition: background-color 0.3s, color 0.3s;
        height: 100vh;
        overflow: hidden; /* App-like feel */
    }

    /* Split Pane Layout */
    .app-container {
        display: grid;
        grid-template-columns: 260px 1fr 1fr; /* Sidebar, Editor, Preview */
        grid-template-rows: 60px 1fr; /* Header, Content */
        height: 100vh;
    }

    /* Header */
    header {
        grid-column: 1 / -1;
        background: var(--panel);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 1.5rem;
        z-index: 10;
    }

    /* Sidebar */
    .sidebar {
        grid-row: 2;
        background: var(--panel);
        border-right: 1px solid var(--border);
        padding: 1rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    /* Main Areas */
    .editor-pane, .preview-pane {
        grid-row: 2;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
    }
    
    .editor-pane { border-right: 1px solid var(--border); }

    /* Toolbar inside panes */
    .pane-toolbar {
        height: 40px;
        background: var(--bg);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 1rem;
        font-size: 0.85rem;
        color: var(--muted);
    }

    /* CodeMirror Override */
    .CodeMirror {
        flex: 1;
        height: auto; 
        font-size: 14px;
        font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
        line-height: 1.6;
    }

    /* Iframe */
    iframe {
        flex: 1;
        width: 100%;
        border: none;
        background: white; /* Preview selalu putih agar akurat */
    }

    /* Buttons */
    .btn-tool {
        width: 100%;
        text-align: left;
        padding: 0.6rem 1rem;
        border-radius: 0.5rem;
        color: var(--text);
        transition: 0.2s;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 500;
        border: 1px solid transparent;
    }
    .btn-tool:hover {
        background: var(--btn-hover);
        border-color: var(--border);
    }
    .btn-tool i { font-size: 1.1em; opacity: 0.8; }

    /* Responsive adjustments */
    @media (max-width: 1024px) {
        .app-container {
            grid-template-columns: 1fr;
            grid-template-rows: auto auto 1fr; /* Header, Toolbar, Content (Tabbed) */
            height: auto;
            min-height: 100vh;
            overflow-y: auto;
        }
        header { position: sticky; top: 0; }
        .sidebar { display: none; } /* Hide sidebar on mobile for now or use drawer */
        .editor-pane, .preview-pane { height: 50vh; border-right: none; border-bottom: 1px solid var(--border); }
    }
  </style>
</head>
<body>

  <div class="app-container">
    
    <!-- HEADER -->
    <header>
        <div class="flex items-center gap-3">
            <i class="bi bi-filetype-html text-orange-500 text-2xl"></i>
            <h1 class="text-xl font-bold tracking-tight">HTML Viewer</h1>
        </div>
        <div class="flex items-center gap-3">
            <button id="btnTheme" class="px-3 py-1.5 rounded-lg border border-gray-600/20 hover:bg-black/5 dark:hover:bg-white/10 text-sm font-medium transition">
                <i class="bi bi-sun-fill"></i> Theme
            </button>
            <a href="{{ url_for('routes.landing') }}" class="px-3 py-1.5 rounded-lg bg-red-500 hover:bg-red-600 text-white text-sm font-bold transition flex items-center gap-2">
                <i class="bi bi-x-lg"></i> Exit
            </a>
        </div>
    </header>

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="text-xs font-bold uppercase text-gray-400 mb-2 px-2">Actions</div>
        
        <button id="btnFormat" class="btn-tool">
            <i class="bi bi-magic text-purple-500"></i> Format Code
        </button>
        <button id="btnClear" class="btn-tool text-red-500 hover:text-red-600">
            <i class="bi bi-trash"></i> Clear All
        </button>
        <button id="btnSample" class="btn-tool">
            <i class="bi bi-lightbulb text-yellow-500"></i> Load Sample
        </button>
        
        <div class="h-px bg-gray-700/20 my-2"></div>

        <div class="text-xs font-bold uppercase text-gray-400 mb-2 px-2">File</div>
        <label class="btn-tool cursor-pointer">
            <i class="bi bi-upload text-blue-500"></i> Import File
            <input type="file" id="fileInput" accept=".html,.htm,.txt,.md" class="hidden">
        </label>
        <button id="btnExport" class="btn-tool">
            <i class="bi bi-download text-green-500"></i> Export HTML
        </button>

        <div class="h-px bg-gray-700/20 my-2"></div>
        
        <div class="text-xs font-bold uppercase text-gray-400 mb-2 px-2">View</div>
        <button id="btnNewTab" class="btn-tool">
            <i class="bi bi-box-arrow-up-right"></i> Open Preview
        </button>
    </aside>

    <!-- EDITOR PANE -->
    <section class="editor-pane">
        <div class="pane-toolbar">
            <span class="font-bold flex items-center gap-2"><i class="bi bi-code-slash"></i> Source Code</span>
            <span id="charCount" class="text-xs opacity-70">0 chars</span>
        </div>
        <textarea id="editor"></textarea>
    </section>

    <!-- PREVIEW PANE -->
    <section class="preview-pane">
        <div class="pane-toolbar">
            <span class="font-bold flex items-center gap-2"><i class="bi bi-eye"></i> Live Preview</span>
            <label class="flex items-center gap-2 text-xs cursor-pointer select-none" title="Allow scripts to run (Caution!)">
                <input type="checkbox" id="allowScripts" class="rounded text-blue-600 focus:ring-blue-500 bg-gray-700 border-gray-600">
                <span>Run Scripts</span>
            </label>
        </div>
        <iframe id="previewFrame" sandbox="allow-same-origin allow-forms allow-popups allow-modals"></iframe>
    </section>

  </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/xml-fold.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchtags.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.9/beautify-html.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. Init Editor ---
        const editorArea = document.getElementById('editor');
        const cm = CodeMirror.fromTextArea(editorArea, {
            mode: 'htmlmixed',
            lineNumbers: true,
            lineWrapping: true,
            theme: 'xq-light',
            matchTags: {bothTags: true},
            extraKeys: {"Ctrl-Space": "autocomplete"},
            tabSize: 2,
        });

        // Theme Sync
        const syncTheme = () => {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            cm.setOption('theme', isDark ? 'material-darker' : 'xq-light');
        };
        syncTheme();
        document.getElementById('btnTheme').addEventListener('click', () => setTimeout(syncTheme, 50));

        // --- 2. Live Preview Logic ---
        const previewFrame = document.getElementById('previewFrame');
        const allowScripts = document.getElementById('allowScripts');
        const charCount = document.getElementById('charCount');

        const updatePreview = () => {
            const content = cm.getValue();
            charCount.textContent = `${content.length.toLocaleString()} chars`;

            // Security: Toggle sandbox attribute for scripts
            const baseSandbox = "allow-same-origin allow-forms allow-popups allow-modals";
            previewFrame.setAttribute("sandbox", allowScripts.checked ? baseSandbox + " allow-scripts" : baseSandbox);

            previewFrame.srcdoc = content;
        };

        // Debounce update
        let timeout;
        cm.on('change', () => {
            clearTimeout(timeout);
            timeout = setTimeout(updatePreview, 300);
        });

        allowScripts.addEventListener('change', updatePreview);

        // --- 3. Toolbar Actions ---
        
        // Format HTML (Beautify)
        document.getElementById('btnFormat').addEventListener('click', () => {
            const raw = cm.getValue();
            const formatted = html_beautify(raw, { 
                indent_size: 2, 
                preserve_newlines: false 
            });
            cm.setValue(formatted);
        });

        // Clear
        document.getElementById('btnClear').addEventListener('click', () => {
            if(confirm('Are you sure you want to clear the editor?')) {
                cm.setValue('');
            }
        });

        // Load Sample
        document.getElementById('btnSample').addEventListener('click', () => {
            const sample = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sample Page</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background: #f0f9ff; color: #0f172a; }
        .card { background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); text-align: center; }
        h1 { color: #3b82f6; margin-bottom: 0.5rem; }
        button { background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; transition: 0.2s; }
        button:hover { background: #2563eb; transform: translateY(-2px); }
    </style>
</head>
<body>
    <div class="card">
        <h1>Hello World! üåç</h1>
        <p>This is a live preview of your HTML code.</p>
        <br>
        <button onclick="alert('It works! üöÄ')">Click Me</button>
    </div>
</body>
</html>`;
            cm.setValue(sample);
        });

        // Import File
        const fileInput = document.getElementById('fileInput');
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => cm.setValue(e.target.result);
            reader.readAsText(file);
        });

        // Export File
        document.getElementById('btnExport').addEventListener('click', () => {
            const blob = new Blob([cm.getValue()], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'index.html';
            a.click();
            URL.revokeObjectURL(url);
        });

        // Open in New Tab
        document.getElementById('btnNewTab').addEventListener('click', () => {
            const win = window.open();
            win.document.write(cm.getValue());
            win.document.close();
        });

        // Initial Load
        if(!cm.getValue()) {
            document.getElementById('btnSample').click();
        }
    });
  </script>
</body>
</html>